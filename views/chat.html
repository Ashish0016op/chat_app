<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
    }

    header {
        background-color: #007BFF;
        color: white;
        text-align: center;
        padding: 20px 0;
    }

    .container {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .sidebar {
        flex: 1;
        background-color: #fff;
        padding: 70px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .user-groups, .create-group {
        margin-bottom: 20px;
    }

    .chat {
        flex: 2;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h2 {
        margin: 0 0 20px;
    }

    ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    #text-field{
        margin-top: 165px;
    }
    #groupName, #text-field {
        width: 50%;
        padding: 10px;
        font-size: 16px;
        border: 2px solid #007BFF;
        border-radius: 5px;
        outline: none;
        margin-bottom: 10px;
    }

    #createButton, #button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #createButton:hover, #button:hover {
        background-color: #0056b3;
    }

    #chatDetails {
        max-height: 400px;
        overflow-y: scroll;
    }
    form#chatForm {
        margin-top: -150px;
    }
    .groupCreated{
        text-decoration: none;
        list-style: none;
    }
    ul#userGroups {
        font-weight: bold;
    }
    .groups{
        background-color: #007BFF;
        color: white;
        margin-bottom: 4px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        height: 26px;
        width: 100px;
    }
    .groupsButton{
        background-color: #007BFF;
        color: white;
        margin-bottom: 4px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .groupsButton:hover{
        background-color: #0056b3;
    }
    .chat-messages {
        margin-top: 14px;
    }
</style>
</head>
<body>
    <header>
        <h1>Chat App</h1>
    </header>
    <main class="container">
        <aside class="sidebar">
            <section class="user-groups">
                <h2>Your Groups</h2>
                <ul id="userGroups">
                </ul>
                <hr style="height: 3px; background-color: black;">
                <h3 id="GroupUsers"></h3>
                <h3 id="deleteGroup"></h3>
            </section>
            <section class="create-group">
                <h2>Create a Group</h2>
                <form id="createGroupForm">
                    <input type="text" id="groupName" placeholder="Group Name" required>
                    <button type="button" id="createButton">Create Group</button>
                </form>
            </section>
        </aside>
        <section class="chat">
            <div class="user-info">
                <h3 id="userGroupName"></h3>
                <p id="userJoined1">You joined</p>
                <ul id="userJoined">
                </ul>
            </div>
            <div class="chat-messages">
                <ul id="chatDetails">
                </ul>
                <form id="chatForm" action="/chatData" method="POST">
                    <input type="text" id="text-field" placeholder="Type your message" required>
                    <button type="submit" id="button">Send</button>
                </form>
            </div>
        </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const createButton=document.getElementById('createButton');
        createButton.addEventListener('click',postGroup);
        async function postGroup(e){
            e.preventDefault();
            try{
                const groupName=document.getElementById('groupName').value;
                const userId=localStorage.getItem('userId');
                const obj={
                    GroupName:groupName,
                    userId:userId
                }
                const token=localStorage.getItem('token');
                
                const groupNames=await axios.post(`http://localhost:5500/group`,obj,{
                    headers:{
                        "Authorization":token
                    }
                })
                const groupId=groupNames.data.group.id;
                localStorage.setItem('groupId',groupId);
                localStorage.setItem('groupName',groupName);
                const userGroups=document.getElementById('userGroups');
                const li=document.createElement('li');
                const button=document.createElement('button');
                button.className='groups';
                button.append(document.createTextNode(groupName));
                button.addEventListener('click',fetchGroup);
                const groupObj={
                    userId:userId,
                    groupId:groupId
                }
                const AdminId=await axios.post('http://localhost:5500/AdminData',groupObj,{
                    headers:{
                        "Authorization":token
                    }
                })
                userGroups.appendChild(button);
                
            }catch(e){
                console.log(e);
            }
        }
        async function fetchGroup(){
            try{
                const groupId=localStorage.getItem('groupId');
                const groupName=localStorage.getItem('groupName');
                const userDetailsButtonId = `userDetailsButton_${groupId}`;
                var buttons = document.getElementsByClassName("groupsButton");
                for (var i = buttons.length - 1; i >= 0; i--) {
                    buttons[i].parentNode.removeChild(buttons[i]);
                }
                const userDetailsButton = document.getElementById(userDetailsButtonId);
                if (!userDetailsButton) {
                    const GroupUsers=document.getElementById('GroupUsers');
                    const UserDetailsButton=document.createElement('button');
                    UserDetailsButton.textContent=`${groupName} Users`;
                    UserDetailsButton.className='groupsButton';
                    UserDetailsButton.id = userDetailsButtonId;
                    UserDetailsButton.addEventListener('click',async()=>{
                        window.location.href="/AllGroupsUsers";
                    });
                    const deleteButtons=document.getElementsByClassName('DeleteGroups')
                    for(let i=deleteButtons.length-1;i>=0;i--){
                        console.log(deleteButtons[i].parentNode);
                        deleteGroup.removeChild(deleteButtons[i]);
                        
                    }
                    const token=localStorage.getItem('token');
                    const userId=localStorage.getItem('userId');
                    const AdminId=await axios.get(`http://localhost:5500/GetAdminData?userId=${userId}&groupId=${groupId}`,{
                        headers:{
                            "Authorization":token
                        }
                    })
                    if (AdminId.data.AdminId && AdminId.data.AdminId.userId){
                        if(parseInt(userId)===AdminId.data.AdminId.userId && parseInt(groupId)===AdminId.data.AdminId.groupId){
                            const deleteGroup=document.getElementById('deleteGroup');
                            const deleteButton=document.createElement('button');
                            deleteButton.className='DeleteGroups';
                            deleteButton.textContent='delete group';
                            deleteButton.addEventListener('click',DeleteGroup);
                            deleteGroup.appendChild(deleteButton);
                        }
                    }
                    GroupUsers.appendChild(UserDetailsButton);
                    
                }
                const token=localStorage.getItem('token');
                const userGroupName=document.getElementById('userGroupName');
                userGroupName.innerHTML=groupName;
                const getChat = await axios.get(`http://localhost:5500/userChat?groupId=${groupId}`, {
                    headers: {
                            "Authorization": token
                    }
                });
                const chatDetails=document.getElementById('chatDetails');
                chatDetails.innerHTML='';
                getChat.data.chatDetails.forEach(element=>{
                        const li=document.createElement('li');
                        li.innerHTML=element.Username+": "+element.Chat;
                        chatDetails.appendChild(li);
                })
            }catch(e){
                console.log(e);
            }
        }
        const userGroups=document.getElementById('userGroups');
        document.addEventListener('DOMContentLoaded',getGroup);
        async function getGroup(e){
            e.preventDefault();
            try{
                
                const userId=localStorage.getItem('userId');
                const token=localStorage.getItem('token');
                const getGroupName=await axios.get(`http://localhost:5500/get_group?userId=${userId}`,{
                    headers:{
                        "Authorization":token
                    }
                })
                getGroupName.data.group.forEach(element => {
                    const userGroupName=document.getElementById('userGroupName');
                    const button=document.createElement('button');
                    button.className='groups';
                    button.append(document.createTextNode(element.GroupName));
                    button.addEventListener('click',async()=>{
                        userGroupName.innerHTML=element.GroupName;
                        localStorage.setItem('groupName',element.GroupName);
                        localStorage.setItem('groupId',element.id);
                        const groupId=localStorage.getItem('groupId');
                        const userDetailsButtonId = `userDetailsButton_${groupId}`;
                        var buttons = document.getElementsByClassName("groupsButton");
                        for (var i = buttons.length - 1; i >= 0; i--) {
                            buttons[i].parentNode.removeChild(buttons[i]);
                        }
                        const userDetailsButton = document.getElementById(userDetailsButtonId);
                        if (!userDetailsButton) {
                            const GroupUsers=document.getElementById('GroupUsers');
                            const UserDetailsButton=document.createElement('button');
                            UserDetailsButton.textContent=`${element.GroupName} Users`;
                            UserDetailsButton.className='groupsButton';
                            UserDetailsButton.id = userDetailsButtonId;
                            UserDetailsButton.addEventListener('click',async()=>{
                                window.location.href="/AllGroupsUsers";
                            });
                            GroupUsers.appendChild(UserDetailsButton);
                        }
                        const deleteButtons=document.getElementsByClassName('DeleteGroups')
                        for(let i=deleteButtons.length-1;i>=0;i--){
                            console.log(deleteButtons[i].parentNode);
                            deleteGroup.removeChild(deleteButtons[i]);
                            
                        }
                        const token=localStorage.getItem('token');
                        const AdminId=await axios.get(`http://localhost:5500/GetAdminData?userId=${userId}&groupId=${groupId}`,{
                            headers:{
                                "Authorization":token
                            }
                        })
                        if (AdminId.data.AdminId && AdminId.data.AdminId.userId){
                            if(parseInt(userId)===AdminId.data.AdminId.userId && parseInt(groupId)===AdminId.data.AdminId.groupId){
                                const deleteGroup=document.getElementById('deleteGroup');
                                const deleteButton=document.createElement('button');
                                deleteButton.className='DeleteGroups';
                                deleteButton.textContent='delete group';
                                deleteButton.addEventListener('click',DeleteGroup);
                                deleteGroup.appendChild(deleteButton);
                            }
                        }
                        const getChat = await axios.get(`http://localhost:5500/userChat?groupId=${groupId}`, {
                            headers: {
                                "Authorization": token
                            }
                        });
                        if(userGroupName.innerHTML!==''){
                            const chatDetails=document.getElementById('chatDetails');
                            chatDetails.innerHTML='';
                            getChat.data.chatDetails.forEach(element=>{
                                const li=document.createElement('li');
                                li.innerHTML=element.Username+": "+element.Chat;
                                chatDetails.appendChild(li);
                            })
                        }
                    })
                    userGroups.appendChild(button);
                    
                    const lineBreak = document.createElement('br');
                    userGroups.appendChild(lineBreak);
                });
            }catch(e){
                console.log(e)
            }
        }
        async function DeleteGroup(){
            try{
                
                var ul = document.getElementById("userGroups");
                const groupName=localStorage.getItem('groupName');
                var buttons = ul.querySelectorAll("button.groups");
                buttons.forEach(function(button) {
                    if (button.textContent === groupName) {
                        button.parentNode.removeChild(button);
                    }
                });
                const groupId=localStorage.getItem('groupId');
                const token=localStorage.getItem('token');
                const GetGroupName=await axios.delete(`http://localhost:5500/deleteGroup?groupId=${groupId}`,{
                    headers:{
                        "Authorization":token
                    }
                })
                console.log(GetGroupName);
            }catch(e){
                console.log(e);
            }
        }
        const button=document.getElementById('button');
        button.addEventListener('click',sendMessages);
        async function sendMessages(e){
            e.preventDefault();
            try{
                const textChat=document.getElementById('text-field').value;
                const username=localStorage.getItem('name');
                const groupId=localStorage.getItem('groupId');
                const userId=localStorage.getItem('userId');
                const obj={
                    Chat:textChat,
                    Username:username,
                    groupId:groupId,
                    userId:userId
                }
                
                const token=localStorage.getItem('token');
                const userGroupName=document.getElementById('userGroupName');
                if(userGroupName.innerHTML===''){
                    console.log('error');
                }else{
                    const sendChat=await axios.post('http://localhost:5500/chatDetails',obj,{
                        headers:{
                            "Authorization":token
                        }
                    })
                    const chatArray=JSON.parse(localStorage.getItem('chatData')) || [];
                    const messages={
                            Chat:textChat,
                            Username:username,
                            groupId:groupId,
                            id:sendChat.data.chatDetails.id
                    }
                    chatArray.push(messages);
                    localStorage.setItem('chatData',JSON.stringify(chatArray));
                    console.log(sendChat.data.chatDetails.id);
                }
                const chatDetails=document.getElementById('chatDetails');
                const li=document.createElement('li');
                li.innerHTML=username+": "+textChat;
                chatDetails.appendChild(li);
                
            }catch(e){
                console.log(e);
            }
        }
        document.addEventListener('DOMContentLoaded',showChatMessages);
        async function showChatMessages(e){
            e.preventDefault();
            try{
                const groupId=localStorage.getItem('groupId');
                const userId=localStorage.getItem('userId');
                const token=localStorage.getItem('token');
                const groupName=await axios.get(`http://localhost:5500/get_groupName?groupId=${groupId}`,{
                    headers:{
                        "Authorization":token
                    }
                })
                const userGroupName=document.getElementById('userGroupName');        
                userGroupName.innerHTML=groupName.data.group.GroupName;
                console.log(groupName.data.group.GroupName);
                const getChat = await axios.get(`http://localhost:5500/userChat?groupId=${groupId}`, {
                    headers: {
                        "Authorization": token
                    }
                });
                if(userGroupName.innerHTML!==''){
                    getChat.data.chatDetails.forEach(element=>{
                        const chatDetails=document.getElementById('chatDetails');
                        const li=document.createElement('li');
                        li.innerHTML=element.Username+": "+element.Chat;
                        chatDetails.appendChild(li);
                    })
                }
            }catch(e){
                console.log(e);
            }
        }
        async function realTimeChatMessages(){
            try{
                const chatMessages = localStorage.getItem('chatData');
                const parseChatmessages = JSON.parse(chatMessages);
                const groupId = localStorage.getItem('groupId');
                const userId = localStorage.getItem('userId');
                const chatDetails = document.getElementById('chatDetails');
                if(parseChatmessages){
                    const token = localStorage.getItem('token');
                    const getGroupId = await axios.get(`http://localhost:5500/userChat?groupId=${groupId}`, {
                        headers: {
                            "Authorization": token
                        }
                    });
                    const lastGroupId = Math.max(...getGroupId.data.chatDetails.map(element => element.id));
                    const localStorageChatId=Math.max(...parseChatmessages.map(element=>element.id));
                    if (lastGroupId>localStorageChatId) {
                        chatDetails.innerHTML = '';
                        const lastMessage = getGroupId.data.chatDetails.find(element => element.id === lastGroupId);
                        console.log(lastMessage);
                        if (lastMessage) {
                            const obj = {
                                Username: lastMessage.Username,
                                Chat: lastMessage.Chat,
                                groupId: groupId,
                                id:lastGroupId
                            };

                            parseChatmessages.push(obj);
                            parseChatmessages.forEach(element=>{
                                console.log(element.Chat);
                                const li = document.createElement('li');
                                li.innerHTML = element.Username+": "+element.Chat;
                                chatDetails.appendChild(li);
                            })
                            localStorage.setItem('chatData', JSON.stringify(parseChatmessages));
                        }
                    }
                }
            } catch (error) {
                console.error(error);
            }
        }
        setInterval(realTimeChatMessages,20000);
    </script>
</body>
</html>